/**
 * Copyright (c) Bjarki Gudlaugsson (codehugger at codehuggers.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without modification, are
 * permitted provided that the following conditions are met:
 *
 *     * Redistributions of source code must retain the above copyright notice, this list of
 *        conditions and the following disclaimer.
 *
 *     * Redistributions in binary form must reproduce the above copyright notice, this
 *       list of conditions and the following disclaimer in the documentation and/or other
 *       materials  provided with the distribution.
 *
 *     * Neither the name of the <ORGANIZATION> nor the names of its contributors may be
 *       used to endorse or promote products derived from this software without specific
 *       prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
 * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL
 * THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT
 * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
 * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
 * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE,  EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/

(function(a){Date.prototype.daysInMonth=function(){return new Date(this.getFullYear(),this.getMonth()+1,0).getDate()};Date.prototype.getWeek=function(){var b=new Date(this.getFullYear(),0,1);return Math.ceil((((this-b)/86400000)+b.getDay()+1)/7)};Date.prototype.startOfDay=function(){return new Date(this.getFullYear(),this.getMonth(),this.getDate(),0,0,0,0)};Date.prototype.endOfDay=function(){return new Date(this.getFullYear(),this.getMonth(),this.getDate(),23,59,59,999)};Date.prototype.startOfWeek=function(){return new Date(this.getFullYear(),this.getMonth(),this.getDate()-this.getDay()).startOfDay()};Date.prototype.endOfWeek=function(){return new Date(this.getFullYear(),this.getMonth(),this.getDate()+(6-this.getDay())).endOfDay()};Date.prototype.startOfMonth=function(){return new Date(this.getFullYear(),this.getMonth(),1).startOfDay()};Date.prototype.endOfMonth=function(){return new Date(this.getFullYear(),this.getMonth(),this.daysInMonth()).endOfDay()};Date.prototype.startOfCalendar=function(){return(new Date(this.getFullYear(),this.getMonth(),1)).startOfWeek()};Date.prototype.endOfCalendar=function(){return(new Date(this.getFullYear(),this.getMonth(),this.daysInMonth())).endOfWeek()};a.fn.rangepicker=function(y){var m=this;var u=new Date().startOfDay().valueOf();var k=7;var z=6;var E=0;var C=1;var F=2;var x=3;var h=["day","week","month","custom"];var e,j;var d,v,t,n,A,w,c;var I,p,o,s,J,f,K,l,r,B,D,H;var q,g,G,i,b;m.dayClicked=function(L){selectedDate=new Date(a(this).attr("id"));if(cyclePeriodTypes){if(d.valueOf()===selectedDate.valueOf()&&n==E){n=C}else{if(d.valueOf()===selectedDate.valueOf()&&n==C){n=F}else{if(d.valueOf()===selectedDate.valueOf()&&n==F){n=E}}}}d=selectedDate;m.updateRange();if((n===x&&followCustom)||(n!==x&&followFixed)){A=selectedDate.startOfMonth()}m.render();L.preventDefault()};m.fixedClicked=function(L){d=new Date(v);n=E;A=v.startOfMonth();m.realizePeriodType();m.updateRange();m.render();L.preventDefault()};m.customClicked=function(L){n=x;w=false;m.render();L.preventDefault()};m.prevMonth=function(M){var L=A.getMonth()-1;if(L<0){A.setFullYear(A.getFullYear()-1);L=11}A.setMonth(L);m.render();M.preventDefault()};m.nextMonth=function(M){var L=A.getMonth()+1;if(L>11){A.setFullYear(A.getFullYear()+1);L=0}A.setMonth(L);m.render();M.preventDefault()};m.prevYear=function(L){A.setFullYear(A.getFullYear()-1);m.render();L.preventDefault()};m.nextYear=function(L){A.setFullYear(A.getFullYear()+1);m.render();L.preventDefault()};m.fromClicked=function(L){A=new Date(v.startOfMonth());m.render();L.preventDefault()};m.todayClicked=function(L){A=new Date(u).startOfMonth();m.render();L.preventDefault()};m.toClicked=function(L){A=new Date(t.startOfMonth());m.render();L.preventDefault()};m.buildDay=function(M){var L=a(J);L.attr("id",M.strftime(j));L.html(M.getDate());if(M.valueOf()===u){L.addClass(G)}if(M.valueOf()>=v.valueOf()&&M.valueOf()<=t.valueOf()){L.addClass(g)}if(n===x){if(M.valueOf()===v.startOfDay().valueOf()||M.valueOf()===t.startOfDay().valueOf()){L.addClass(q)}}else{if(M.valueOf()===d.valueOf()){L.addClass(q)}}if(M.getMonth()!==A.getMonth()){L.addClass(i)}if((minDate===null||M>minDate)&&(maxDate===null||M<maxDate)){L.on("click",m.dayClicked)}else{L.on("click",function(N){N.preventDefault()});L.addClass("disabled")}return L};m.buildWeek=function(M){var L=a(s);for(var N=0;N<k;N++){L.append(m.buildDay(new Date(M)));M.setDate(M.getDate()+1)}return L};m.buildMonth=function(L){var N=a(o);for(var M=0;M<z;M++){N.append(m.buildWeek(new Date(L)));L.setDate(L.getDate()+k)}return N};m.buildCalendar=function(){return a(p).append(m.buildMonth(new Date(A.startOfCalendar())))};m.buildRange=function(){var N=a(rangeTemplate);var L=a(fromTemplate);var O=a(todayTemplate);var M=a(toTemplate);L.attr("id",v.strftime(j));L.html(v.strftime(j));O.attr("id",new Date(u).strftime(j));M.attr("id",t.strftime(j));M.html(t.strftime(j));L.on("click",m.fromClicked);O.on("click",m.todayClicked);M.on("click",m.toClicked);N.append(L);N.append(O);N.append(M);return N};m.buildNav=function(){var Q=a(f);var P=a(prevYearTemplate);var N=a(prevMonthTemplate);var M=a(l).html(A.strftime(e));var O=a(nextMonthTemplate);var L=a(nextYearTemplate);if(minDate===null||minDate.getFullYear()<A.getFullYear()){P.on("click",m.prevYear)}else{P.on("click",function(R){R.preventDefault()});P.addClass("disabled")}if(minDate===null||minDate<A){N.on("click",m.prevMonth)}else{N.on("click",function(R){R.preventDefault()});N.addClass("disabled")}if(maxDate===null||maxDate>A.endOfMonth()){O.on("click",m.nextMonth)}else{O.on("click",function(R){R.preventDefault()});O.addClass("disabled")}if(maxDate===null||maxDate.getFullYear()>A.getFullYear()){L.on("click",m.nextYear)}else{L.on("click",function(R){R.preventDefault()});L.addClass("disabled")}Q.append(P);Q.append(N);Q.append(M);Q.append(O);Q.append(L);return Q};m.buildModeSelection=function(){var M=a(B);var L=a(D);var N=a(H);L.on("click",m.fixedClicked);N.on("click",m.customClicked);M.append(L);M.append(N);if(n===x){N.addClass(b)}else{L.addClass(b)}return M};m.updateRange=function(){if(n===x){if(w){t=d.endOfDay();if(v>t){var L=v.startOfDay();v=t.startOfDay();t=L}m.triggerOnUpdate()}else{v=d.startOfDay();t=d.endOfDay()}w=!w}else{from=new Date(d.valueOf());to=new Date(d.valueOf());if(n===E){from=from.startOfDay();to=to.endOfDay()}else{if(n===C){from=from.startOfWeek();to=to.endOfWeek()}else{if(n===F){from=from.startOfMonth();to=to.endOfMonth()}}}if(minDate&&from<minDate){from=new Date(minDate.valueOf())}if(maxDate&&to>maxDate){to=new Date(maxDate.valueOf())}v=from;t=to;m.triggerOnUpdate()}};m.triggerOnUpdate=function(){if(c){c([v,t])}};m.triggerOnInit=function(){if(onInit){onInit([v,t])}};m.realizePeriodType=function(){var M=v.startOfDay();var L=t.startOfDay();if(M.valueOf()==L.valueOf()&&n!=x){n=E}else{if(M.getDay()===0&&L.getDay()===6&&M.getWeek()===L.getWeek()&&n!==x){n=C}else{if(M.getMonth()===L.getMonth()&&M.getDate()===1&&(L.getDate()===M.daysInMonth()||L.getDate()===maxDate.getDate())&&n!==x){n=F}else{w=false;n=x}}}};m.render=function(){var L=a(I);L.append(m.buildNav());L.append(m.buildRange());L.append(m.buildCalendar());L.append(m.buildModeSelection());m.html(L)};m.init=function(L){if(L===undefined){L={}}d=L.currentDate||new Date().startOfDay();v=L.dateFrom||d.startOfDay();t=L.dateTo||d.endOfDay();n=L.periodType||"day";A=L.displayedDate||d.startOfMonth();onInit=L.onInit||undefined;c=L.onUpdate||undefined;cyclePeriodTypes=L.cycleModes||true;w=false;j=L.dateFormat||"%Y-%m-%d";e=L.labelFormat||"%B %Y";minDate=L.minDate||null;maxDate=L.maxDate||new Date();followFixed=L.followFixed||true;followCustom=L.followCustom||false;I=L.rootTemplate||'<div class="rangepicker"></div>';J=L.dayTemplate||'<a href="#" class="day"></a>';s=L.weekTemplate||'<div class="week"></div>';o=L.monthTemplate||'<div class="month"></div>';p=L.calendarTemplate||'<div class="calendar"></div>';f=L.navTemplate||'<div class="navigation"></div>';prevYearTemplate=L.prevTemplate||'<a href="#" class="prev">&laquo;</a>';prevMonthTemplate=L.prevTemplate||'<a href="#" class="prev">&lsaquo;</a>';l=L.displayTemplate||'<span class="display"></span>';nextMonthTemplate=L.nextTemplate||'<a href="#" class="next">&rsaquo;</a>';nextYearTemplate=L.nextTemplate||'<a href="#" class="next">&raquo;</a>';rangeTemplate=L.rangeTemplate||'<div class="range"></div>';fromTemplate=L.fromTemplate||'<a href="#" class="from"></a>';todayTemplate=L.todayTemplate||'<a href="#" class="today">Today</a>';toTemplate=L.toTemplate||'<a href="#" class="to"></a>';B=L.modeTemplate||'<div class="mode"></div>';D=L.fixedTemplate||'<a href="#" class="fixed">Fixed</a>';H=L.customTemplate||'<a href="#" class="custom">Custom</a>';i=L.disabledClass||"disabled";q=L.selectedClass||"selected";g=L.includedClass||"included";b=L.activeClass||"active";G=L.todayClass||"today";a.each(function(M,N){if(N===n){n=M}});if(v&&t){n=E;m.realizePeriodType();d=v.startOfDay()}A=v.startOfMonth();m.triggerOnInit();m.render();return m};return m.init(y)}}(jQuery));